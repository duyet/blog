{"componentChunkName":"component---src-templates-post-template-js","path":"/2017/09/detect-cars-opencv.html","result":{"data":{"markdownRemark":{"id":"af0f8f72-5edc-5e84-9f37-8728dab10cfb","html":"<p>Trong bài này, mình sẽ hướng dẫn sử dụng OpenCV để nhận diện xe hơi trong ảnh (video frame) với <a href=\"https://en.wikipedia.org/wiki/Haar-like_features\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">đặc trưng haar</a>, sử dụng file mô hình đã được trained.</p>\n<p>Bài viết chỉ giúp hình dung code trên Opencv chứ không đi sâu vào thuật toán. Trong bài này mình sẽ hướng dẫn cách build/install opencv trên Ubuntu, một chương trình đơn giản detect 1 vùng ảnh, phân loại đó có phải xe hơi hay không và vẽ 1 hình chữ nhật đánh dấu.</p>\n<h2 id=\"cài-đặt-opencv-trên-ubuntu\" style=\"position:relative;\"><a href=\"#c%C3%A0i-%C4%91%E1%BA%B7t-opencv-tr%C3%AAn-ubuntu\" aria-label=\"cài đặt opencv trên ubuntu permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cài đặt OpenCV trên Ubuntu</h2>\n<p>Sử dụng Windows hay Fedora bạn có thể cài đặt dễ dàng <a href=\"http://docs.opencv.org/3.0-beta/doc/py_tutorials/py_setup/py_table_of_contents_setup/py_table_of_contents_setup.html#py-table-of-content-setup\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">theo hướng dẫn này</a>, còn mình sử dụng Ubuntu nên phải build từ source.</p>\n<p>Cài đặt trước một số package/thư viện để build opencv:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get install build-essential cmake pkg-config\nsudo apt-get install libjpeg8-dev libtiff5-dev libjasper-dev libpng12-dev # image \nsudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev # codec, video\nsudo apt-get install libgtk-3-dev # opencv GUI\nsudo apt-get install libatlas-base-dev gfortran</code></pre></div>\n<p>Download source từ Github, mình sử dụng version 3.1.0:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">wget -O opencv.zip https://github.com/Itseez/opencv/archive/3.1.0.zip\nunzip opencv.zip\nwget -O opencv_contrib.zip https://github.com/Itseez/opencv_contrib/archive/3.1.0.zip\nunzip opencv_contrib.zip</code></pre></div>\n<p>OpenCV yêu cầu dependency là numpy</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install numpy</code></pre></div>\n<p>Bắt đầu build source:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> opencv-3.1.0/\n<span class=\"token function\">mkdir</span> build\n<span class=\"token builtin class-name\">cd</span> build\ncmake -D <span class=\"token assign-left variable\">CMAKE_BUILD_TYPE</span><span class=\"token operator\">=</span>RELEASE <span class=\"token punctuation\">\\</span>\n    -D <span class=\"token assign-left variable\">CMAKE_INSTALL_PREFIX</span><span class=\"token operator\">=</span>/usr/local <span class=\"token punctuation\">\\</span>\n    -D <span class=\"token assign-left variable\">INSTALL_PYTHON_EXAMPLES</span><span class=\"token operator\">=</span>ON <span class=\"token punctuation\">\\</span>\n    -D <span class=\"token assign-left variable\">INSTALL_C_EXAMPLES</span><span class=\"token operator\">=</span>OFF <span class=\"token punctuation\">\\</span>\n    -D <span class=\"token assign-left variable\">OPENCV_EXTRA_MODULES_PATH</span><span class=\"token operator\">=</span><span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/opencv_contrib-3.1.0/modules <span class=\"token punctuation\">\\</span>\n    -D <span class=\"token assign-left variable\">BUILD_EXAMPLES</span><span class=\"token operator\">=</span>ON <span class=\"token punctuation\">..</span> </code></pre></div>\n<p>Note: Nếu trong quá trình build bị lỗi stdlib.h: No such file or directory thì chỉ cần tạo lại thư mục build, thêm tham số <code class=\"language-text\">-D ENABLE_PRECOMPILED_HEADERS=OFF</code> vào lệnh cmake</p>\n<p>Sau khi build xong, để sử dụng được Python 2, bạn phải chú ý đường dẫn của Interpreter, Libraries, numpy, và packages path có chính xác hay không.</p>\n<p><a href=\"https://2.bp.blogspot.com/-u1Fqw11luYo/WcE3gP_ykFI/AAAAAAAAngY/iPfg5bwKCcIVn5XTgM3SnVjKzf0QRBBegCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B22-27-44.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://2.bp.blogspot.com/-u1Fqw11luYo/WcE3gP_ykFI/AAAAAAAAngY/iPfg5bwKCcIVn5XTgM3SnVjKzf0QRBBegCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B22-27-44.png\"></a></p>\n<p>Sau khi Cmake không còn lỗi, bắt đầu build (-j4 là sử dụng 4 core để build)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">make -j4</code></pre></div>\n<p><a href=\"https://4.bp.blogspot.com/-0SnmDeM2B0M/WcE4AXJN6JI/AAAAAAAAngg/KQt_S4_zH3Q8se_FZHqIhB-KcElleplMwCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B22-29-22.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://4.bp.blogspot.com/-0SnmDeM2B0M/WcE4AXJN6JI/AAAAAAAAngg/KQt_S4_zH3Q8se_FZHqIhB-KcElleplMwCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B22-29-22.png\"></a></p>\n<p>Bước cuối cùng, install vào OS:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo make install\nsudo ldconfig</code></pre></div>\n<p>Đã xong, kiểm tra thử đã cài đặt thành công hay chưa:</p>\n<p><a href=\"https://3.bp.blogspot.com/-ADZP1py__HQ/WcFHipA-fGI/AAAAAAAAngw/KqEojie1Hb4Bhr3CSXLZpfGpqkq7zXZhgCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B23-35-52.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://3.bp.blogspot.com/-ADZP1py__HQ/WcFHipA-fGI/AAAAAAAAngw/KqEojie1Hb4Bhr3CSXLZpfGpqkq7zXZhgCLcBGAs/s1600/Screenshot%2Bfrom%2B2017-09-19%2B23-35-52.png\"></a></p>\n<p>Sau khi cài thành công, có thể xóa source nếu không cần thiết nữa:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">rm -rf opencv-3.1.0 opencv_contrib-3.1.0 opencv.zip opencv_contrib.zip</code></pre></div>\n<h2 id=\"nhận-dạng-xe\" style=\"position:relative;\"><a href=\"#nh%E1%BA%ADn-d%E1%BA%A1ng-xe\" aria-label=\"nhận dạng xe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nhận dạng xe</h2>\n<p>Load thư viện opencv, nếu bạn sử dụng Jupyter notebook thì import cả matplotlib để hiển thị ảnh inline ngay trên cell output.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span>matplotlib inline\n<span class=\"token keyword\">import</span> cv2\n\n<span class=\"token comment\"># Will use matplotlib for showing the image in notebook</span>\n<span class=\"token comment\"># Sử dụng matplotlib để hiển thị ảnh trên notebook</span>\n<span class=\"token keyword\">from</span> matplotlib <span class=\"token keyword\">import</span> pyplot <span class=\"token keyword\">as</span> plt</code></pre></div>\n<p>Tải <a href=\"https://github.com/duyet/opencv-car-detection/blob/master/cars.xml\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cars.xml</a> bỏ vào thư mục làm việc. Đây là Cascade Classifier ảnh. Kế tiếp đọc ảnh và chuyển sang chế độ màu gray.</p>\n<p>Ta có ảnh sau:</p>\n<p><a href=\"https://3.bp.blogspot.com/-Y8l5HW2tOko/WcKOUHuXN2I/AAAAAAAAni0/ImCsNb-J7WU9VSwmo4VJjlnKBrMuSO34wCLcBGAs/s1600/car3.jpg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://3.bp.blogspot.com/-Y8l5HW2tOko/WcKOUHuXN2I/AAAAAAAAni0/ImCsNb-J7WU9VSwmo4VJjlnKBrMuSO34wCLcBGAs/s1600/car3.jpg\"></a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">car_cascade <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>CascadeClassifier<span class=\"token punctuation\">(</span><span class=\"token string\">'cars.xml'</span><span class=\"token punctuation\">)</span>\nimg <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>imread<span class=\"token punctuation\">(</span><span class=\"token string\">'car3.jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\ngray <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>COLOR_BGR2GRAY<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Sử dụng detectMultiScale để detect xe, sau đó vẽ border hình chữ nhật để đánh dấu vị trí trên ảnh.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Detect cars</span>\ncars <span class=\"token operator\">=</span> car_cascade<span class=\"token punctuation\">.</span>detectMultiScale<span class=\"token punctuation\">(</span>gray<span class=\"token punctuation\">,</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Draw border</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> cars<span class=\"token punctuation\">:</span>\n    cv2<span class=\"token punctuation\">.</span>rectangle<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>w<span class=\"token punctuation\">,</span>y<span class=\"token operator\">+</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    ncars <span class=\"token operator\">=</span> ncars <span class=\"token operator\">+</span> <span class=\"token number\">1</span></code></pre></div>\n<p>Cuối cùng hiển thị kết quả</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Show image</span>\nplt<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span></code></pre></div>\n<p><a href=\"https://4.bp.blogspot.com/-Q7hQ2nkdYOs/WcKOoh1NVhI/AAAAAAAAnjE/nuDEVWj14-stCPHc4aWj1UFc7GyGTudNwCK4BGAYYCw/s1600/result_car1.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://4.bp.blogspot.com/-Q7hQ2nkdYOs/WcKOoh1NVhI/AAAAAAAAnjE/nuDEVWj14-stCPHc4aWj1UFc7GyGTudNwCK4BGAYYCw/s1600/result_car1.png\"></a>\nTest một số ảnh khác:</p>\n<p><a href=\"https://4.bp.blogspot.com/-CS1Ort8e2S8/WcKO5VqKyUI/AAAAAAAAnjI/H5ViCGDoxGcdtoE8qgaKdjoSuRsrKCM4gCLcBGAs/s1600/car2.jpg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://4.bp.blogspot.com/-CS1Ort8e2S8/WcKO5VqKyUI/AAAAAAAAnjI/H5ViCGDoxGcdtoE8qgaKdjoSuRsrKCM4gCLcBGAs/s800/car2.jpg\"></a></p>\n<p><a href=\"https://1.bp.blogspot.com/-Sx90cRHgP4s/WcKO5d4IRGI/AAAAAAAAnjM/gp0RZ17opasM_xxlTQGid7cX-WqC9BRRwCLcBGAs/s1600/result_car2.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://1.bp.blogspot.com/-Sx90cRHgP4s/WcKO5d4IRGI/AAAAAAAAnjM/gp0RZ17opasM_xxlTQGid7cX-WqC9BRRwCLcBGAs/s800/result_car2.png\"></a></p>\n<p>Source code đầy đủ chương trình trên:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> cv2\n<span class=\"token keyword\">from</span> matplotlib <span class=\"token keyword\">import</span> pyplot <span class=\"token keyword\">as</span> plt\n\ncar_cascade <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>CascadeClassifier<span class=\"token punctuation\">(</span><span class=\"token string\">'cars.xml'</span><span class=\"token punctuation\">)</span>\nimg <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>imread<span class=\"token punctuation\">(</span><span class=\"token string\">'car3.jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\ngray <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>COLOR_BGR2GRAY<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Detect cars</span>\ncars <span class=\"token operator\">=</span> car_cascade<span class=\"token punctuation\">.</span>detectMultiScale<span class=\"token punctuation\">(</span>gray<span class=\"token punctuation\">,</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Draw border</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> cars<span class=\"token punctuation\">:</span>\n    cv2<span class=\"token punctuation\">.</span>rectangle<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>w<span class=\"token punctuation\">,</span>y<span class=\"token operator\">+</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    ncars <span class=\"token operator\">=</span> ncars <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\n<span class=\"token comment\"># Show image</span>\nplt<span class=\"token punctuation\">.</span>figure<span class=\"token punctuation\">(</span>figsize<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kết quả nhận dạng phụ thuộc nhiều vào Cascade cars.xml đã train trước, nên có thể kết quả nhận diện không hoàn toàn chính xác.</p>\n<p>Tham khảo:</p>\n<ul>\n<li><a href=\"http://docs.opencv.org/trunk/d7/d8b/tutorial_py_face_detection.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://docs.opencv.org/trunk/d7/d8b/tutorial<em>py</em>face_detection.html</a></li>\n<li><a href=\"http://docs.opencv.org/2.4/doc/tutorials/objdetect/cascade_classifier/cascade_classifier.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://docs.opencv.org/2.4/doc/tutorials/objdetect/cascade<em>classifier/cascade</em>classifier.html</a></li>\n<li>Source code trong bài: <a href=\"https://github.com/duyet/opencv-car-detection\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/duyet/opencv-car-detection</a></li>\n</ul>","fields":{"slug":"/2017/09/detect-cars-opencv.html","tagSlugs":["/tag/data-engineer/","/tag/opencv/","/tag/image/","/tag/python/","/tag/javascript/","/tag/machine-learning/"]},"frontmatter":{"date":"2017-09-20T23:07:00.004+07:00","description":"Trong bài này, mình sẽ hướng dẫn sử dụng OpenCV để nhận diện xe hơi trong ảnh (video frame) với đặc trưng HAAR, sử dụng file mô hình đã được trained.","tags":["Data Engineer","opencv","image","Python","javascript","Machine Learning"],"title":"Python - Nhận dạng xe hơi với OpenCV","fbCommentUrl":"none"}}},"pageContext":{"slug":"/2017/09/detect-cars-opencv.html"}},"staticQueryHashes":["251939775","2672868365","401334301"]}