{"componentChunkName":"component---src-templates-post-template-js","path":"/2015/04/mongodb-cach-thiet-lap-e-app-server-ket.html","result":{"data":{"markdownRemark":{"id":"9c95da4b-5afa-5f2d-9510-a6392a9afacd","html":"<p>Thông thường, chúng ta thường thiết lập để Code và phần Database chung 1 server. Với những ứng dụng lớn để quản lý, chúng ta phải tách riêng biệt chúng trên nhiều server khác nhau.\nBởi vì mặc định MongoDb không cho phép remote connections mà chỉ cho phép kết nối nội bộ. Mình sẽ hướng dẫn cách thiết lập sao cho từ App Server (server chứa code) kết nối được tới MongoDb Server (hoặc cụm MongoDb Server)</p>\n<p>Thông tin cấu hình của môi trường test:</p>\n<ol>\n<li>MongoDB Server</li>\n<li>Private IP – 192.168.161.100</li>\n<li>Public IP – 45.56.65.100</li>\n<li>MongoDB 2.6.3, port 27017</li>\n<li>IpTables Firewall</li>\n<li>Application Server (Same LAN network)</li>\n<li>Private IP – 192.168.161.200</li>\n<li>Public IP – irrelevant</li>\n<li>Developers at home (Different LAN network, WAN)</li>\n<li>Public IP – 10.0.0.1</li>\n</ol>\n<h2 id=\"1-bind-ip\" style=\"position:relative;\"><a href=\"#1-bind-ip\" aria-label=\"1 bind ip permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Bind IP</h2>\n<p>Mở <code class=\"language-text\">/etc/mongod.conf</code> tìm đến dòng bind_ip</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ vim /etc/mongod.conf\n\n# /etc/mongod.conf\n\n# Listen to local interface only. Comment out to listen on all interfaces.\nbind_ip = 127.0.0.1</code></pre></div>\n<p>Mặc định MongoDb chỉ cho phép kết nối từ nội bộ (127.0.0.1), nên nhiệm vụ của bạn là sửa đổi thông tin này, 1 số trường hợp như sau: </p>\n<h3 id=\"1-listen-on-all-interfaces\" style=\"position:relative;\"><a href=\"#1-listen-on-all-interfaces\" aria-label=\"1 listen on all interfaces permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. listen on all interfaces</h3>\n<p>Nếu bạn chẳng cần quan tâm cái quái gì là bảo mật, thì xóa dòng <code class=\"language-text\">bind_ip = 127.0.0.1</code> đi, hoặc sửa thành <code class=\"language-text\">bind_ip = 0.0.0.0</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Listen to local interface only. Comment out to listen on all interfaces.\n# bind_ip = 127.0.0.1</code></pre></div>\n<h3 id=\"2-chỉ-cho-phép-kết-nối-từ-mạng-nội-bộ-lan\" style=\"position:relative;\"><a href=\"#2-ch%E1%BB%89-cho-ph%C3%A9p-k%E1%BA%BFt-n%E1%BB%91i-t%E1%BB%AB-m%E1%BA%A1ng-n%E1%BB%99i-b%E1%BB%99-lan\" aria-label=\"2 chỉ cho phép kết nối từ mạng nội bộ lan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Chỉ cho phép kết nối từ mạng nội bộ (LAN)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ vim /etc/mongod.conf\n\n# /etc/mongod.conf\n\n# Listen to local and LAN interfaces.\nbind_ip = 127.0.0.1,192.168.161.100</code></pre></div>\n<p>Nhớ là đặt IP Private, không phải IP Public của App Server nha </p>\n<h3 id=\"3-cho-phép-kết-nối-từ-bất-cứ-ip-nào\" style=\"position:relative;\"><a href=\"#3-cho-ph%C3%A9p-k%E1%BA%BFt-n%E1%BB%91i-t%E1%BB%AB-b%E1%BA%A5t-c%E1%BB%A9-ip-n%C3%A0o\" aria-label=\"3 cho phép kết nối từ bất cứ ip nào permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Cho phép kết nối từ bất cứ IP nào</h3>\n<p>Trường hợp server đặt tại công ty, bạn muốn máy ở nhà kết nối đến để sử dụng. Bạn có thể kết nối đến MongoDb thông qua địa chỉ Public IP 45.56.65.100</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ vim /etc/mongod.conf\n\n# /etc/mongod.conf\n\n# Listen to local, LAN and Public interfaces.\nbind_ip = 127.0.0.1,192.168.161.100,45.56.65.100</code></pre></div>\n<p>Mình khuyên là nên sử dụng một mạng riêng ảo VPN để đảm bảo tính bảo mật hơn cách này. </p>\n<hr>\n<p>Khởi động lại MongoDb để thay đổi có tác dụng: </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo service mongod restart\n[ ok ] Restarting database: mongod.</code></pre></div>\n<h2 id=\"2-iptables-firewall\" style=\"position:relative;\"><a href=\"#2-iptables-firewall\" aria-label=\"2 iptables firewall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. IpTables Firewall</h2>\n<p>Nếu bạn có đặt tường lửa, hãy thiết lập lại sao cho tường lửa cho phép kết nối thông qua Port của của MongoDb (mặc định là 27017)</p>\n<p>Ở đây mình sử dụng iptables để thiết lập kết nối đến trên Ubuntu </p>\n<p>Cho phép mọi kết nối thông qua cổng 27017</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">iptables -A INPUT -p tcp --dport 27017 -j ACCEPT</code></pre></div>\n<p>Hoặc, chỉ cho phép kết nối từ 1 IP cụ thể (ở đây là IP của App Server)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">iptables -A INPUT -s IP_HERE -p tcp --destination-port 27017 -m state --state NEW,ESTABLISHED -j ACCEPT\niptables -A OUTPUT -d IP_HERE -p tcp --source-port 27017 -m state --state ESTABLISHED -j ACCEPT</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">iptables -A INPUT -s 192.168.161.200 -p tcp --destination-port 27017 -m state --state NEW,ESTABLISHED -j ACCEPT\niptables -A OUTPUT -d 192.168.161.200 -p tcp --source-port 27017 -m state --state ESTABLISHED -j ACCEPT</code></pre></div>\n<p>Xong rồi đấy, chúc thành công :))</p>\n<p>Xem thêm tại đây <a href=\"http://docs.mongodb.org/manual/tutorial/configure-linux-iptables-firewall/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MongoDB firewall documentation</a></p>","fields":{"slug":"/2015/04/mongodb-cach-thiet-lap-e-app-server-ket.html","tagSlugs":["/tag/linux/","/tag/mongo-db/","/tag/server/","/tag/ubuntu/"]},"frontmatter":{"date":"2015-04-09T16:10:00.001+07:00","description":"Thông thường, chúng ta thường thiết lập để Code và phần Database chung 1 server. Với những ứng dụng lớn để quản lý, chúng ta phải tách riêng biệt chúng trên nhiều server khác nhau. Bởi vì mặc định MongoDb không cho phép remote connections mà chỉ cho phép kết nối nội bộ. Mình sẽ hướng dẫn cách thiết lập sao cho từ App Server (server chứa code) kết nối được tới MongoDb Server (hoặc cụm MongoDb Server)","tags":["Linux","MongoDb","Server","Ubuntu"],"title":"MongoDB - Cách thiết lập để App Server kết nối đến MongoDb Server","fbCommentUrl":null}}},"pageContext":{"slug":"/2015/04/mongodb-cach-thiet-lap-e-app-server-ket.html"}}}