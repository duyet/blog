{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/08/airflow-docker-compose.html","result":{"data":{"markdownRemark":{"id":"adb3b695-0091-5ee8-a466-78a97f9d9ae5","html":"<p>Trong bài này mình sẽ hướng dẫn cách thiết lập môi trường develop Apache Airflow dưới local bằng Docker Compose.</p>\n<p><strong>TL;DR</strong> Source ví dụ của bài viết này: <a href=\"https://github.com/duyet/airflow-docker-compose\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/duyet/airflow-docker-compose</a></p>\n<p><figure class=\"md-figure\"><img src=\"https://1.bp.blogspot.com/-vBHaHxwvMFw/XWQHodWBFeI/AAAAAAABGCg/Hdlx-I1PSx8_Gip6o7N_2mejUSsT2TCigCLcBGAs/s1600/Screen%2BShot%2B2019-08-26%2Bat%2B11.22.59%2BPM.png\"><figcaption>Airflow in Docker Compose</figcaption></figure></p>\n<h1 id=\"1-cấu-trúc-project\" style=\"position:relative;\"><a href=\"#1-c%E1%BA%A5u-tr%C3%BAc-project\" aria-label=\"1 cấu trúc project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Cấu trúc project</h1>\n<p>Đầu tiên thiết lập cấu trúc project như dưới đây. Thư mục <code class=\"language-text\">dags</code> sẽ chứa các DAG python của Airflow.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">.</span>\n├── dags\n│   └── first_dag.py\n├── Dockerfile\n└── docker-compose.yaml</code></pre></div>\n<h2 id=\"11-dockerfile\" style=\"position:relative;\"><a href=\"#11-dockerfile\" aria-label=\"11 dockerfile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 <code class=\"language-text\">Dockerfile</code></h2>\n<p>Nội dung file <code class=\"language-text\">Dockerfile</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> puckel/docker<span class=\"token punctuation\">-</span>airflow<span class=\"token punctuation\">:</span>1.10.4\n<span class=\"token keyword\">COPY</span> dags /usr/local/airflow/dags\n<span class=\"token comment\"># RUN pip install &lt;packages> ...</span></code></pre></div>\n<p><code class=\"language-text\">Dockerfile</code> ở đây mình kế thừa của tác giả <a href=\"https://github.com/puckel/docker-airflow\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Puckel</a>, <code class=\"language-text\">COPY</code> thư mục <code class=\"language-text\">dags</code> vào Docker image. Có thể cài thêm các thư viện khác bằng lệnh Docker <code class=\"language-text\">RUN &lt;cmd&gt;</code>.</p>\n<h2 id=\"12-docker-composeyaml\" style=\"position:relative;\"><a href=\"#12-docker-composeyaml\" aria-label=\"12 docker composeyaml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 <code class=\"language-text\">docker-compose.yaml</code></h2>\n<p>Nội dung file <code class=\"language-text\">docker-compose.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'2.1'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">postgres</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span><span class=\"token number\">9.6</span>\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> POSTGRES_USER=airflow\n            <span class=\"token punctuation\">-</span> POSTGRES_PASSWORD=airflow\n            <span class=\"token punctuation\">-</span> POSTGRES_DB=airflow\n        <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> /tmp/postgres<span class=\"token punctuation\">-</span>data<span class=\"token punctuation\">:</span>/var/lib/postgresql/data\n\n    <span class=\"token key atrule\">webserver</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .\n        <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n        <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> postgres\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> LOAD_EX=n\n            <span class=\"token punctuation\">-</span> EXECUTOR=Local\n            <span class=\"token punctuation\">-</span> AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2<span class=\"token punctuation\">:</span>//airflow<span class=\"token punctuation\">:</span>airflow@postgres<span class=\"token punctuation\">:</span>5432/airflow\n        <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./dags<span class=\"token punctuation\">:</span>/usr/local/airflow/dags\n            <span class=\"token punctuation\">-</span> /tmp/airflow_logs<span class=\"token punctuation\">:</span>/root/airflow/logs\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"8080:8080\"</span>\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> webserver\n        <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CMD-SHELL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"[ -f /usr/local/airflow/airflow-webserver.pid ]\"</span><span class=\"token punctuation\">]</span>\n            <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n            <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 30s\n            <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\n    <span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .\n        <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n        <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> postgres\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> LOAD_EX=n\n            <span class=\"token punctuation\">-</span> EXECUTOR=Local\n            <span class=\"token punctuation\">-</span> AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2<span class=\"token punctuation\">:</span>//airflow<span class=\"token punctuation\">:</span>airflow@postgres<span class=\"token punctuation\">:</span>5432/airflow\n        <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./dags<span class=\"token punctuation\">:</span>/usr/local/airflow/dags\n            <span class=\"token punctuation\">-</span> /tmp/airflow_logs<span class=\"token punctuation\">:</span>/root/airflow/logs\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> scheduler</code></pre></div>\n<p>Docker compose mình thiết lập gồm các service:</p>\n<ul>\n<li>Postgres</li>\n<li>Airflow Webserver</li>\n<li>Airflow Scheduler</li>\n</ul>\n<p>Mount thư mục <code class=\"language-text\">./dags:/opt/airflow/dags</code> để link thư mục <code class=\"language-text\">dags</code> với thư mục trong Docker instance.</p>\n<blockquote>\n<p>Note: mount thư mục <code class=\"language-text\">/root/airflow/logs</code> để Webserver có thể đọc được logs từ Scheduler.</p>\n</blockquote>\n<h1 id=\"2-chạy-docker-compose\" style=\"position:relative;\"><a href=\"#2-ch%E1%BA%A1y-docker-compose\" aria-label=\"2 chạy docker compose permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Chạy Docker compose</h1>\n<p>Tại thư mục project:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker-compose up</code></pre></div>\n<p><figure class=\"md-figure\"><img src=\"https://1.bp.blogspot.com/-ITYnJ2ylqug/XWQGI_t08CI/AAAAAAABGCM/NjRtqyCsJlYw1mWgdVYzkNX1bqBTSf47QCLcBGAs/s1600/Screen%2BShot%2B2019-08-26%2Bat%2B11.12.49%2BPM.png\"><figcaption>Docker Compose Up - Terminal</figcaption></figure></p>\n<p>Truy cập Airflow: <a href=\"http://localhost:8080\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:8080</a></p>\n<p><figure class=\"md-figure\"><img src=\"https://1.bp.blogspot.com/-odCDCFx2JsY/XWQG6olVq7I/AAAAAAABGCU/9qEsVmVoMGwMgja_aifZlrU8vUk5ZIeVgCLcBGAs/s1600/Screen%2BShot%2B2019-08-26%2Bat%2B11.20.36%2BPM.png\"><figcaption>Airflow UI in Local</figcaption></figure></p>\n<p>Từ bây giờ mình có thể viết và test các DAG bằng cách viết trong thư mục <code class=\"language-text\">dags</code>.</p>\n<p>Chúc các bạn thành công.</p>\n<h1 id=\"tham-khảo\" style=\"position:relative;\"><a href=\"#tham-kh%E1%BA%A3o\" aria-label=\"tham khảo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tham khảo</h1>\n<ul>\n<li><a href=\"https://github.com/duyet/airflow-docker-compose\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/duyet/airflow-docker-compose</a></li>\n<li><a href=\"https://github.com/puckel/docker-airflow\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">puckel/docker-airflow</a></li>\n<li><a href=\"https://towardsdatascience.com/getting-started-with-airflow-using-docker-cd8b44dbff98\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://towardsdatascience.com/getting-started-with-airflow-using-docker-cd8b44dbff98</a></li>\n</ul>","fields":{"slug":"/2019/08/airflow-docker-compose.html","tagSlugs":["/tag/airflow/","/tag/data/","/tag/data-engineer/"]},"frontmatter":{"date":"2019-08-26T15:00:00.000+07:00","description":"Trong bài này mình sẽ hướng dẫn cách thiết lập môi trường develop Apache Airflow dưới local bằng Docker Compose.","tags":["Airflow","Data","Data Engineer"],"title":"Cài đặt Apache Airflow với Docker Compose","fbCommentUrl":"none"}}},"pageContext":{"slug":"/2019/08/airflow-docker-compose.html"}}}