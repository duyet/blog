{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/08/slack-alerts-in-airflow.html","result":{"data":{"markdownRemark":{"id":"c2edc1e6-bcb8-5797-a21d-fefffef0ca92","html":"<p>Slack là một công cụ khá phổ biến trong các Team, slack giúp tập hợp mọi thông tin về Slack (như Jira alert, ETL pipelines, CI/CD status, deployments, …) một cách thống nhất và dễ dàng theo dõi. Bài viết này mình hướng dẫn gửi mọi báo lỗi của Airflow đến Slack.</p>\n<h1 id=\"1-slack-incoming-webhooks-và-airflow-connection\" style=\"position:relative;\"><a href=\"#1-slack-incoming-webhooks-v%C3%A0-airflow-connection\" aria-label=\"1 slack incoming webhooks và airflow connection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Slack Incoming Webhooks và Airflow Connection</h1>\n<p>Truy cập Slack App Directory tìm Incoming Webhooks: <code class=\"language-text\">https://&lt;workspace&gt;.slack.com/apps/A0F7XDUAZ-incoming-webhooks</code></p>\n<p><img src=\"https://1.bp.blogspot.com/-mskOJFO7b-8/XVwRLj7cHfI/AAAAAAABFzo/RL59VK0ntqE5tS4B_N2n_Fw9loUQ4nR4QCLcBGAs/s1600/Pasted_Image_8_20_19__10_25_PM.png\"></p>\n<p>Ở mục <strong>Post to Channel</strong> chọn Channel, sau đó bấm <strong>Add Incoming Webhooks integration</strong></p>\n<p><img src=\"https://1.bp.blogspot.com/-YwSGP7SSxg4/XVwRuuixzcI/AAAAAAABFzw/ukZRvTux-g0AM6MVGJdwyvKDMqFpfDpLgCLcBGAs/s1600/Screen%2BShot%2B2019-08-20%2Bat%2B10.28.21%2BPM.png\"></p>\n<p>Sau đó bạn sẽ nhận được 1 URL có dạng:\n<a href=\"https://hooks.slack.com/services/T00000000/B0000000/hssA66nupi72KAFy9ttv5fr2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://hooks.slack.com/services/T00000000/B0000000/hssA66nupi72KAFy9ttv5fr2</a></p>\n<p><img src=\"https://1.bp.blogspot.com/-5wTS8VRYK4M/XVwSPb4dlTI/AAAAAAABFz8/mnADDTCj0eEAe-WsLN5yaCTWVPOlkefxgCLcBGAs/s1600/Pasted_Image_8_20_19__10_29_PM.png\"></p>\n<p>Vào <strong>Airflow</strong> > <strong>Admin</strong> >  <strong>Connections</strong> để thêm một connection mới</p>\n<ul>\n<li>Conn Id: <code class=\"language-text\">Slack</code></li>\n<li>Conn Type: <code class=\"language-text\">HTTP</code></li>\n<li>Host: <code class=\"language-text\">https://hooks.slack.com/services</code></li>\n<li>Password: <code class=\"language-text\">/T00000000/B0000000/hssA66nupi72KAFy9ttv5fr2</code></li>\n</ul>\n<p><img src=\"https://1.bp.blogspot.com/-zoKGhbURtjo/XVwVX5YOLTI/AAAAAAABF0I/3oitPGuOHwweJLli5Kjai8bC-Bbp7ighQCLcBGAs/s1600/Pasted_Image_8_20_19__10_43_PM.png\"></p>\n<h1 id=\"2-slack-alert-utils\" style=\"position:relative;\"><a href=\"#2-slack-alert-utils\" aria-label=\"2 slack alert utils permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Slack alert Utils</h1>\n<p>Tạo file utils chứa function alert, ví dụ: <code class=\"language-text\">/dags/utils/slack_alert.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span>base_hook <span class=\"token keyword\">import</span> BaseHook\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>operators<span class=\"token punctuation\">.</span>slack_webhook_operator <span class=\"token keyword\">import</span> SlackWebhookOperator\n\nSLACK_CONN_ID <span class=\"token operator\">=</span> <span class=\"token string\">'slack'</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">task_fail_slack_alert</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    slack_webhook_token <span class=\"token operator\">=</span> BaseHook<span class=\"token punctuation\">.</span>get_connection<span class=\"token punctuation\">(</span>SLACK_CONN_ID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>password\n    slack_msg <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">\"\"\"\nTask Failed. \n*DAG*: {dag_id} \n*Task*: {task}  \n*Dag*: {dag} \n*Execution Time*: {exec_date}  \n*Log Url*: {log_url} \n    \"\"\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n        dag_id<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'dag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>dag_id<span class=\"token punctuation\">,</span>\n        task<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'task_instance'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>task_id<span class=\"token punctuation\">,</span>\n        dag<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'task_instance'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>dag_id<span class=\"token punctuation\">,</span>\n        ti<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'task_instance'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        exec_date<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'execution_date'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        log_url<span class=\"token operator\">=</span>context<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'task_instance'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>log_url<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    failed_alert <span class=\"token operator\">=</span> SlackWebhookOperator<span class=\"token punctuation\">(</span>\n        task_id<span class=\"token operator\">=</span><span class=\"token string\">'slack_alert'</span><span class=\"token punctuation\">,</span>\n        http_conn_id<span class=\"token operator\">=</span>SLACK_CONN_ID<span class=\"token punctuation\">,</span>\n        webhook_token<span class=\"token operator\">=</span>slack_webhook_token<span class=\"token punctuation\">,</span>\n        message<span class=\"token operator\">=</span>slack_msg<span class=\"token punctuation\">,</span>\n        username<span class=\"token operator\">=</span><span class=\"token string\">'airflow'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> failed_alert<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>context<span class=\"token operator\">=</span>context<span class=\"token punctuation\">)</span></code></pre></div>\n<h1 id=\"3-config-slack-alert-cho-từng-dag\" style=\"position:relative;\"><a href=\"#3-config-slack-alert-cho-t%E1%BB%ABng-dag\" aria-label=\"3 config slack alert cho từng dag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Config Slack alert cho từng DAG</h1>\n<p>Với mỗi DAG muốn alert, ta thêm thuộc tính <code class=\"language-text\">on_failure_callback</code> cho mỗi DAG. Ví dụ như dưới dây:</p>\n<p><code class=\"language-text\">example_dag.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> airflow <span class=\"token keyword\">import</span> DAG\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">from</span> utils<span class=\"token punctuation\">.</span>slack_alert <span class=\"token keyword\">import</span> task_fail_slack_alert\n\n\ndefault_args <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">**</span>params<span class=\"token punctuation\">[</span><span class=\"token string\">'default_args'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'owner'</span><span class=\"token punctuation\">:</span> DAG_OWNER<span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'on_failure_callback'</span><span class=\"token punctuation\">:</span> task_fail_slack_alert<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\ndag <span class=\"token operator\">=</span> DAG<span class=\"token punctuation\">(</span><span class=\"token string\">'dag_id'</span><span class=\"token punctuation\">,</span> default_args<span class=\"token operator\">=</span>default_args<span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>Kết quả:</p>\n<p><img src=\"https://1.bp.blogspot.com/-jAfy6D8deHU/XVwQdvnubFI/AAAAAAABFzg/b3ASQC3mmtozUhAQPdBRa3mJGE-Cd23GgCLcBGAs/s1600/airflow-alert-slack.png\"></p>\n<h1 id=\"tham-khảo\" style=\"position:relative;\"><a href=\"#tham-kh%E1%BA%A3o\" aria-label=\"tham khảo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tham khảo</h1>\n<ul>\n<li><a href=\"https://medium.com/datareply/integrating-slack-alerts-in-airflow-c9dcd155105\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://medium.com/datareply/integrating-slack-alerts-in-airflow-c9dcd155105</a></li>\n<li>airflow.operators.slack_operator: <a href=\"https://airflow.apache.org/_modules/airflow/operators/slack_operator.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://airflow.apache.org/_modules/airflow/operators/slack_operator.html</a></li>\n</ul>\n<p>Chúc các bạn thành công.</p>","fields":{"slug":"/2019/08/slack-alerts-in-airflow.html","tagSlugs":["/tag/airflow/","/tag/data/","/tag/data-engineer/"]},"frontmatter":{"date":"2019-08-20T22:10:00.000+07:00","description":"Slack là một công cụ khá phổ biến trong các Team, slack giúp tập hợp mọi thông tin về Slack (như Jira alert, ETL pipelines, CI/CD status, deployments, ...) một cách thống nhất và dễ dàng theo dõi. Bài viết này mình hướng dẫn gửi mọi báo lỗi của Airflow đến Slack.","tags":["Airflow","Data","Data Engineer"],"title":"Gửi Slack Alerts trên Airflow","fbCommentUrl":"none"}}},"pageContext":{"slug":"/2019/08/slack-alerts-in-airflow.html"}}}