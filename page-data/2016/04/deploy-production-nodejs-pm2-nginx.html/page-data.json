{"componentChunkName":"component---src-templates-post-template-tsx","path":"/2016/04/deploy-production-nodejs-pm2-nginx.html","result":{"data":{"markdownRemark":{"id":"cec91b55-3656-50f1-808e-9030cf80c808","html":"<p>Cách cài đặt và triển khai production Node.js project với Nginx và PM2.</p>\n<p><img src=\"https://3.bp.blogspot.com/-hgi6cDJuaP0/VxTAu2i1SII/AAAAAAAATkU/k_reis6UEhAElFCqjjolcrW6_j-bjZUfACK4B/s1600/logo_pm2.png\"></p>\n<h2 id=\"chuẩn-bị\" style=\"position:relative;\"><a href=\"#chu%E1%BA%A9n-b%E1%BB%8B\" aria-label=\"chuẩn bị permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chuẩn bị</h2>\n<p>Đưa code lên server, nên sử dụng Git</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd ~/project\ngit clone https://github.com/saveto-co/saveto &amp;&amp; cd saveto</code></pre></div>\n<p>Sau đó cài đặt các package (npm, bower), các phần mềm và cơ sở dữ liệu cần thiết, … </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install\nbower install\n\n# Ví dụ\nsudo apt-get install mongodb # mongodb\nsudo apt-get install redis-server # redis </code></pre></div>\n<h2 id=\"cài-đặt-nginx-và-pm2\" style=\"position:relative;\"><a href=\"#c%C3%A0i-%C4%91%E1%BA%B7t-nginx-v%C3%A0-pm2\" aria-label=\"cài đặt nginx và pm2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cài đặt Nginx và PM2</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get install nginx\nsudo npm install -g pm2</code></pre></div>\n<h2 id=\"khởi-động-pm2\" style=\"position:relative;\"><a href=\"#kh%E1%BB%9Fi-%C4%91%E1%BB%99ng-pm2\" aria-label=\"khởi động pm2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Khởi động PM2</h2>\n<p>Khởi động Webserver sử dụng PM2</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pm2 start app.js --name &quot;app_name&quot; # hay index.js tùy project</code></pre></div>\n<p>Hoặc với các project sử dụng grunt hoặc gulp</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pm2 start $(which grunt) serve:dist --name &quot;app_name&quot; # production mode</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Output:\n┌──────────┬────┬──────┬──────┬────────┬───────────┬────────┬────────────┬──────────┐\n│ App name │ id │ mode │ PID  │ status │ restarted │ uptime │     memory │ watching │\n├──────────┼────┼──────┼──────┼────────┼───────────┼────────┼────────────┼──────────┤\n│ app_name │ 0  │ fork │ 5871 │ online │         0 │ 0s     │ 9.012 MB   │ disabled │\n└──────────┴────┴──────┴──────┴────────┴───────────┴────────┴────────────┴──────────┘</code></pre></div>\n<p>PM2 sẽ tự động chạy ứng dụng Nodejs, tự động restart khi lỗi. PM2 còn kèm theo nhiều plugin với nhiều chức năng như: cân bằng tải, update source no zero down time (cập nhật mã nguồn mà không làm tắt server), scale (tự động mở rộng khả năng chịu tải), tự động cập nhật source code khi Git được update, …\nĐọc thêm về PM2 tại đây: <a href=\"https://github.com/Unitech/pm2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/Unitech/pm2</a></p>\n<p>Ví dụ với ứng dụng trên, PM2 chạy ứng dụng ở port 9000, truy cập http://<ip>:9000 để kiểm tra.</p>\n<h2 id=\"cấu-hình-nginx-reverse-proxy-server\" style=\"position:relative;\"><a href=\"#c%E1%BA%A5u-h%C3%ACnh-nginx-reverse-proxy-server\" aria-label=\"cấu hình nginx reverse proxy server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cấu hình Nginx Reverse Proxy Server</h2>\n<p>Nginx có vai trò như một Reverse Proxy.</p>\n<p><img src=\"https://4.bp.blogspot.com/-8LFBF4hC2s0/VxS8sSs0c9I/AAAAAAAATkI/l1QxbaQsm-oS2KsmXjeAANx8OyeR_qLfACK4B/s1600/68747470733a2f2f6173736574732e6469676974616c6f6365616e2e636f6d2f61727469636c65732f6e6f64656a732f6e6f64655f6469616772616d2e706e67.png\"></p>\n<p>Mở file cấu hình nginx</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo nano /etc/nginx/sites-available/default</code></pre></div>\n<p>Thêm hoặc xóa file cấu hình theo nội dung bên dưới </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n    listen 80;\n\n    server_name example.com;\n\n    location / {\n        proxy_pass http://localhost:9000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection &#39;upgrade&#39;;\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}</code></pre></div>\n<p>Với example.com là domain, thay localhost và port 9000 trùng với thông tin trên server của bạn. Sau đó khởi động lại Nginx</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo service nginx restart</code></pre></div>\n<h2 id=\"bonus\" style=\"position:relative;\"><a href=\"#bonus\" aria-label=\"bonus permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bonus</h2>\n<h3 id=\"khởi-động-lại-application\" style=\"position:relative;\"><a href=\"#kh%E1%BB%9Fi-%C4%91%E1%BB%99ng-l%E1%BA%A1i-application\" aria-label=\"khởi động lại application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Khởi động lại Application</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pm2 restart &lt;appname hoặc appid&gt;</code></pre></div>\n<p>Xem App Name hoặc App ID bằng lệnh:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ pm2 status\n\n┌──────────┬────┬─────────┬──────┬────────┬─────────┬────────┬──────────────┬──────────┐\n│ App name │ id │ mode    │ pid  │ status │ restart │ uptime │ memory       │ watching │\n├──────────┼────┼─────────┼──────┼────────┼─────────┼────────┼──────────────┼──────────┤\n│ quick    │ 0  │ cluster │ 8362 │ online │ 0       │ 12m    │ 110.535 MB   │ disabled │\n│ quick    │ 1  │ cluster │ 8371 │ online │ 0       │ 12m    │ 111.191 MB   │ disabled │\n└──────────┴────┴─────────┴──────┴────────┴─────────┴────────┴──────────────┴──────────┘</code></pre></div>\n<h3 id=\"pm2-tự-động-cập-nhật-mã-nguồn-khi-push-lên-git-link\" style=\"position:relative;\"><a href=\"#pm2-t%E1%BB%B1-%C4%91%E1%BB%99ng-c%E1%BA%ADp-nh%E1%BA%ADt-m%C3%A3-ngu%E1%BB%93n-khi-push-l%C3%AAn-git-link\" aria-label=\"pm2 tự động cập nhật mã nguồn khi push lên git link permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PM2 tự động cập nhật mã nguồn khi push lên Git (<a href=\"https://github.com/saveto-co/wiki/wiki/Production\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">link</a>)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pm2 install pm2-auto-pull</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[PM2][Module] Module downloaded\n[PM2] Process launched\n[PM2][Module] Module successfully installed and launched\n[PM2][Module] : To configure module do\n[PM2][Module] : $ pm2 conf &lt;key&gt; &lt;value&gt;\n┌──────────┬────┬─────────┬──────┬────────┬─────────┬────────┬──────────────┬──────────┐\n│ App name │ id │ mode    │ pid  │ status │ restart │ uptime │ memory       │ watching │\n├──────────┼────┼─────────┼──────┼────────┼─────────┼────────┼──────────────┼──────────┤\n│ quick    │ 0  │ cluster │ 8362 │ online │ 0       │ 12m    │ 110.535 MB   │ disabled │\n│ quick    │ 1  │ cluster │ 8371 │ online │ 0       │ 12m    │ 111.191 MB   │ disabled │\n└──────────┴────┴─────────┴──────┴────────┴─────────┴────────┴──────────────┴──────────┘\n Module activated\n┌───────────────┬─────────┬────────────┬────────┬─────────┬─────┬─────────────┐\n│ Module        │ version │ target PID │ status │ restart │ cpu │ memory      │\n├───────────────┼─────────┼────────────┼────────┼─────────┼─────┼─────────────┤\n│ pm2-auto-pull │ N/A     │ 9360       │ online │ 0       │ 25% │ 12.586 MB   │\n└───────────────┴─────────┴────────────┴────────┴─────────┴─────┴─────────────┘\n Use `pm2 show &lt;id|name&gt;` to get more details about an app</code></pre></div>\n<p>Chỉ cần push mã nguồn lên Git, pm2 sẽ tự động pull về và cài đặt mà không cần truy cập lên server để làm bằng tay. Nên để source code trên server ở nhánh production. Xem thêm về <a href=\"https://blog.duyet.net/2015/07/git-ki-thuat-chia-branch-branch-early.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kỹ thuật làm việc trên Git branch</a> để có thể hiểu hơn về mô hình làm việc này.</p>\n<p>PM2 còn khá nhiều tính năng hữu ích, comment bên dưới để được tôi hỗ trợ thêm nhé.</p>","fields":{"slug":"/2016/04/deploy-production-nodejs-pm2-nginx.html","tagSlugs":["/tag/nodejs/","/tag/tutorial/","/tag/deploy/","/tag/nginx/","/tag/pm-2/"]},"frontmatter":{"date":"2016-04-10T18:12:00.000+07:00","description":"Cách cài đặt và triển khai production Node.js project với Nginx và PM2.","tags":["Nodejs","Tutorial","Deploy","Nginx","PM2"],"title":"Deploy production Node.js với PM2 và Nginx","fbCommentUrl":"http://blog.duyetdev.com/2016/04/deploy-production-nodejs-pm2-nginx.html"}}},"pageContext":{"slug":"/2016/04/deploy-production-nodejs-pm2-nginx.html"}},"staticQueryHashes":["251939775","2672868365","401334301"]}