{"componentChunkName":"component---src-templates-post-template-js","path":"/2020/10/why-spark-on-kubernetes.html","result":{"data":{"markdownRemark":{"id":"d55d3938-6684-5aaa-9e0c-90aa98c6c20d","html":"<p>Apache Spark đã quá nổi tiếng trong thế giới Data Engineering và Big Data. Kubernetes cũng ngày càng phổ biến tương tự, là một hệ thống quản lý deployment và scaling application. Bài viết này đề cập đến một số lợi ích khi <a href=\"https://blog.duyet.net/2020/05/spark-on-k8s.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">triển khai Apache Spark trên hệ thống Kubernetes</a>.</p>\n<p>Có một số lý do bạn bạn nên triển khai Apache Spark trên Kubernetes.</p>\n<h2 id=\"native-option\" style=\"position:relative;\"><a href=\"#native-option\" aria-label=\"native option permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Native option</h2>\n<p>Kubernetes đã trở thành native option cho Spark resource manager kể từ version 2.3 (thay vì Hadoop Yarn, Apache Mesos như trước). Trang tài liệu của Apache Spark có hướng dẫn rất đầy đủ các cài đặt để chạy Spark trên Kubernetes: <a href=\"https://spark.apache.org/docs/latest/running-on-kubernetes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://spark.apache.org/docs/latest/running-on-kubernetes.html</a></p>\n<p><figure class=\"md-figure\"><img src=\"https://spark.apache.org/docs/latest/img/k8s-cluster-mode.png\"><figcaption>spark-submit can be directly used to submit a Spark application to a Kubernetes cluster</figcaption></figure></p>\n<p>Spark sẽ tạo một Spark driver bằng một <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/pod/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kubernetes pod</a>.</p>\n<ul>\n<li>Driver này sẽ tạo các Executors, mỗi executor cũng là một Kubernetes pods và kết nối các Pod này lại với nhau, sau đó thực thi application code.</li>\n<li>Sau khi ứng dụng complete, các Executor pods sẽ bị terminate. Nhưng driver pod sẽ chuyển sang trạng thái <code class=\"language-text\">completed</code> để giữ logs cho đến khi nó bị xóa bởi garbage collected hoặc manually cleaned up.</li>\n</ul>\n<h2 id=\"tận-dụng-sức-mạnh-của-công-nghệ-container\" style=\"position:relative;\"><a href=\"#t%E1%BA%ADn-d%E1%BB%A5ng-s%E1%BB%A9c-m%E1%BA%A1nh-c%E1%BB%A7a-c%C3%B4ng-ngh%E1%BB%87-container\" aria-label=\"tận dụng sức mạnh của công nghệ container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tận dụng sức mạnh của công nghệ Container</h2>\n<p>Chạy Spark trên Kubernetes dưới dạng các pod container, ta tận dụng được nhiều ưu điểm của công nghệ container:</p>\n<ul>\n<li>Đóng gói Spark application, package và dependencies vào cùng một container duy nhất, tránh xung đột phiên bản thư viện với Hadoop hay ứng dụng khác</li>\n<li>Version control bằng cách sử dụng image tags.</li>\n<li>Với cách này, bạn thậm chí còn có thể sử dụng nhiều phiên bản Spark trên cùng một cluster một cách dễ dàng. Ví dụ bạn có thể chạy Spark 2.3 và Spark 3.0 mà không hề có sự xung đột nào.</li>\n</ul>\n<h2 id=\"monitoring-và-logging\" style=\"position:relative;\"><a href=\"#monitoring-v%C3%A0-logging\" aria-label=\"monitoring và logging permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Monitoring và Logging</h2>\n<p>Tận dụng monitoring và logging của Kubernetes: Kubernetes rất mạnh trong việc monitoring các pod, service, node. Bạn có thể dễ dàng xuất log hoặc metrics ra một hệ thống khác như Graylog, <a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elasticsearch</a>, <a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/logging-stackdriver/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stackdriver</a>, <a href=\"https://prometheus.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Prometheus</a>, Statd … bằng cách cài thêm 1 pod logging agent hoặc thêm 1 sidecar container để export.</p>\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/5bde4953b3b232c97a744496aa92e3bbfadda9ce/39767/images/docs/user-guide/logging/logging-with-streaming-sidecar.png\"></p>\n<p>Tham khảo thêm:</p>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Logging Using Elasticsearch and Kibana</a></li>\n<li><a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/logging-stackdriver/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Logging Using Stackdriver</a></li>\n<li><a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/monitor-node-health/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Monitor Node Health</a></li>\n<li><a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tools for Monitoring Resources</a></li>\n<li><a href=\"https://www.datamechanics.co/blog-post/setting-up-managing-monitoring-spark-on-kubernetes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Setting up, Managing &#x26; Monitoring Spark on Kubernetes</a></li>\n</ul>\n<h2 id=\"namespace--resource-quotas\" style=\"position:relative;\"><a href=\"#namespace--resource-quotas\" aria-label=\"namespace  resource quotas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Namespace / Resource quotas</h2>\n<p>Dễ dàng quản lý resources, phân chia giới hạn tài nguyên cho nhiều team bằng cách sử dụng Kubernetes <a href=\"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">namespace</a> và <a href=\"https://kubernetes.io/docs/concepts/policy/resource-quotas/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">resource quotas</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ResourceQuota\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mem<span class=\"token punctuation\">-</span>cpu\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>spark<span class=\"token punctuation\">-</span>staging\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hard</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests.cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500</span>\n    <span class=\"token key atrule\">limits.cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">800</span>\n    <span class=\"token key atrule\">requests.memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"100Gi\"</span>\n    <span class=\"token key atrule\">limits.memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"300Gi\"</span>\n    <span class=\"token key atrule\">pods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500000</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ResourceQuota\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mem<span class=\"token punctuation\">-</span>cpu\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>spark<span class=\"token punctuation\">-</span>production\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hard</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests.cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2000</span>\n    <span class=\"token key atrule\">limits.cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span>\n    <span class=\"token key atrule\">requests.memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"800Gi\"</span>\n    <span class=\"token key atrule\">limits.memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1500Gi\"</span>\n    <span class=\"token key atrule\">pods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500000</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> sparkoperator.k8s.io/v1beta2\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> SparkApplication\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> spark<span class=\"token punctuation\">-</span>log<span class=\"token punctuation\">-</span>processing\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>spark<span class=\"token punctuation\">-</span>production  <span class=\"token comment\"># &lt;-----</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Scala\n  <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> cluster\n  <span class=\"token punctuation\">...</span></code></pre></div>\n<h2 id=\"node-selectors-service-account\" style=\"position:relative;\"><a href=\"#node-selectors-service-account\" aria-label=\"node selectors service account permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node selectors, Service Account</h2>\n<p>Sử dụng Kubernetes <a href=\"https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">node selectors</a> để kiểm soát việc chạy Spark trên các loại máy khác nhau tùy theo mục đích của Spark app.</p>\n<p>Ngoài ra Kubernetes <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">service account</a> dùng để quản lý permission sử dụng <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Role và ClusterRole</a>, cho phép team nào có thể sử dụng cluster nào.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> sparkoperator.k8s.io/v1beta2\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> SparkApplication\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> spark<span class=\"token punctuation\">-</span>log<span class=\"token punctuation\">-</span>processing\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">-</span>production\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Scala\n  <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> cluster\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> gcr.io/spark/spark<span class=\"token punctuation\">:</span>v3.0.0\n  <span class=\"token key atrule\">mainClass</span><span class=\"token punctuation\">:</span> org.duyet.spark.transformation.LogProcessing\n  <span class=\"token key atrule\">mainApplicationFile</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">:</span>//duyet/spark/etl/jars/spark<span class=\"token punctuation\">-</span>log<span class=\"token punctuation\">-</span>processing_2.12<span class=\"token punctuation\">-</span>3.0.0.jar\n\n  <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">disktype</span><span class=\"token punctuation\">:</span> ssd\n    <span class=\"token key atrule\">clusterTeam</span><span class=\"token punctuation\">:</span> team<span class=\"token punctuation\">-</span>duyet\n\n  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> kubernetes.io/e2e<span class=\"token punctuation\">-</span>az<span class=\"token punctuation\">-</span>name\n            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> e2e<span class=\"token punctuation\">-</span>az1\n            <span class=\"token punctuation\">-</span> e2e<span class=\"token punctuation\">-</span>az2\n      <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">preference</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>label\n            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> cluster<span class=\"token punctuation\">-</span>realtime\n            <span class=\"token punctuation\">-</span> cluster<span class=\"token punctuation\">-</span>production</code></pre></div>\n<h2 id=\"kết-luận\" style=\"position:relative;\"><a href=\"#k%E1%BA%BFt-lu%E1%BA%ADn\" aria-label=\"kết luận permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kết luận</h2>\n<p>Mặc dù có nhiều điểm mạnh, Kubernetes scheduler support for Spark vẫn cần nhiều cải thiện do vẫn còn rất mới mẻ, so với thời gian phát triển nhiều năm của YARN hay Mesos.</p>\n<p>Bạn có thể tham khảo các cách để chạy ứng dụng Spark trên Kubernetes như <code class=\"language-text\">spark-submit</code> hay <code class=\"language-text\">Spark Operator</code> ở <a href=\"https://blog.duyet.net/2020/05/spark-on-k8s.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bài viết này</a> và tối ưu hóa Spark trên Kubernetes của AWS <a href=\"https://aws.amazon.com/blogs/containers/optimizing-spark-performance-on-kubernetes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">tại đây</a>.</p>","fields":{"slug":"/2020/10/why-spark-on-kubernetes.html","tagSlugs":["/tag/spark/","/tag/data-engineer/"]},"frontmatter":{"date":"2020-10-24T00:00:00.000+07:00","description":"Spark đã quá nổi tiếng trong thế giới Data Engineering và Bigdata. Kubernetes cũng ngày càng phổ biến tương tự, là một hệ thống quản lý deployment và scaling application. Bài viết này bàn đến một số lợi ích khi triển khai ứng dụng Apache Spark trên hệ thống Kubernetes.","tags":["Spark","Data Engineer"],"title":"Tại sao nên chạy Apache Spark trên Kubernetes","fbCommentUrl":"none"}}},"pageContext":{"slug":"/2020/10/why-spark-on-kubernetes.html"}}}